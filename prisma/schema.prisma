generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model channel_members {
  id           Int       @id @default(autoincrement())
  channel_id   Int
  user_id      Int
  last_read_at DateTime? @db.DateTime(0)
  joined_at    DateTime? @default(now()) @db.DateTime(0)
  channels     channels  @relation(fields: [channel_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "channel_members_ibfk_1")
  users        users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "channel_members_ibfk_2")

  @@unique([channel_id, user_id], map: "channel_id")
  @@index([user_id], map: "user_id")
}

model channels {
  id              Int               @id @default(autoincrement())
  name            String?           @unique @db.VarChar(255)
  description     String?           @db.Text
  is_private      Boolean?          @default(false)
  is_dm           Boolean?          @default(false)
  created_by      Int?
  created_at      DateTime?         @default(now()) @db.DateTime(0)
  updated_at      DateTime?         @default(now()) @db.DateTime(0)
  channel_members channel_members[]
  users           users?            @relation(fields: [created_by], references: [id], onUpdate: Restrict, map: "channels_ibfk_1")
  threads         threads[]

  @@index([created_by], map: "created_by")
}

model messages {
  id               Int       @id @default(autoincrement())
  channel_id       Int?
  sender_id        Int
  content          String?   @db.Text
  files            String?   @db.LongText
  reactions        String?   @db.LongText
  pinned           Boolean   @default(false)
  thread_parent_id Int?
  created_at       DateTime? @default(now()) @db.DateTime(0)
  updated_at       DateTime? @default(now()) @db.DateTime(0)
  threads          threads?  @relation(fields: [thread_parent_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "fk_thread")
  users            users     @relation(fields: [sender_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "messages_ibfk_2")
  is_forwarded     Boolean   @default(false)
  forwarded_from   String?
  is_system        Boolean   @default(false)

  @@index([thread_parent_id], map: "fk_thread")
  @@index([channel_id, created_at], map: "idx_messages_channel_time")
  @@index([sender_id], map: "sender_id")
}

model refresh_tokens {
  id          Int      @id @default(autoincrement())
  user_id     Int
  token_hash  String   @db.VarChar(128)
  expires_at  DateTime @db.DateTime(0)
  created_at  DateTime @default(now())
  revoked     Boolean? @default(false)
  replaced_by String?  @db.VarChar(128)
  device_info String?  @db.VarChar(255)
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "fk_user")

  @@index([user_id], map: "fk_user")
  @@index([token_hash], map: "token_hash")
}

model threads {
  id                Int       @id @default(autoincrement())
  parent_message_id Int
  channel_id        Int
  created_at        DateTime? @default(now()) @db.DateTime(0)

  channels channels   @relation(fields: [channel_id], references: [id])
  messages messages[]
}

model users {
  id              Int               @id @default(autoincrement())
  external_id     String?           @unique(map: "external_id") @db.VarChar(255)
  name            String            @db.VarChar(255)
  email           String            @unique(map: "email") @db.VarChar(255)
  avatar_url      String?           @db.Text
  is_online       Boolean?          @default(false)
  last_seen       DateTime?         @db.DateTime(0)
  created_at      DateTime?         @default(now()) @db.DateTime(0)
  updated_at      DateTime?         @default(now()) @db.DateTime(0)
  password        String            @db.VarChar(255)
  channel_members channel_members[]
  channels        channels[]
  messages        messages[]
  refresh_tokens  refresh_tokens[]
}